# HSA_OVERRIDE_GFX_VERSION â€” required for AMD iGPU (e.g. GMKtec mini-PCs with AMD Radeon).
# Set in .env file: HSA_OVERRIDE_GFX_VERSION=10.3.0

services:
  vision-api:
    image: avzinin/vision-api-server:amd-${IMAGE_TAG:-latest}
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      YOLO_MODELS: ${YOLO_MODELS:-{"yolo11s.pt":"cuda:0","yolo11x.pt":"cuda:0"}}
      YOLO_MODEL_TTL: ${YOLO_MODEL_TTL:-900}
      YOLO_DEVICE: ${YOLO_DEVICE:-cuda:0}
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    devices:
      - "/dev/kfd:/dev/kfd"
      - "/dev/dri:/dev/dri"
    group_add:
      - video
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    ipc: host
    shm_size: 8G
    volumes:
      - models:/models

volumes:
  models:
