services:
  yolo-api:
    build:
      context: ..
      dockerfile: docker/amd/Dockerfile
    ports:
      - "3001:8000"
    environment:
      YOLO_MODELS: ${YOLO_MODELS:-'{"yolo26s.pt":"cuda:0","yolo26x.pt":"cuda:0"}'}
      YOLO_MODEL_TTL: ${YOLO_MODEL_TTL:-900}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      VIDEO_CODEC: ${VIDEO_CODEC:-auto}
      VIDEO_CRF: ${VIDEO_CRF:-18}
      VIDEO_HW_ACCEL: ${VIDEO_HW_ACCEL:-amd}
      HSA_OVERRIDE_GFX_VERSION: ${HSA_OVERRIDE_GFX_VERSION:-}
      YOLO_DEVICE: 'cuda:0'
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    devices:
      - "/dev/kfd:/dev/kfd"
      - "/dev/dri:/dev/dri"
    group_add:
      - video
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined
    ipc: host
    shm_size: 8G
