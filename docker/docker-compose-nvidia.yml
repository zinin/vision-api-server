services:
  yolo-api:
    build:
      context: ..
      dockerfile: docker/nvidia/Dockerfile
    ports:
      - "3001:8000"
    environment:
      YOLO_MODELS: ${YOLO_MODELS:-'{"yolo11s.pt":"cuda:0","yolo11x.pt":"cuda:0"}'}
      YOLO_MODEL_TTL: ${YOLO_MODEL_TTL:-900}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      VIDEO_CODEC: ${VIDEO_CODEC:-h264}
      VIDEO_CRF: ${VIDEO_CRF:-18}
      YOLO_DEVICE: 'cuda:0'
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
