# Merged Design Review — Iteration 1

## codex-executor (gpt-5.3-codex)

### Critical Issues
- Требование "полный cutover, старые модели не поддерживаются" не реализуется текущим дизайном. В коде по-прежнему можно запросить любую модель строкой (`app/main.py:313`, `app/main.py:376`, `app/main.py:406`), а менеджер попытается загрузить её динамически (`app/model_manager.py:169`). Валидация `YOLO_MODELS` проверяет только формат JSON, а не семейство моделей (`app/config.py:39`).
  Следствие: без изменений логики миграция не отключает `yolo11`/`yolov8` фактически.

- Ключевой риск, заявленный в дизайне (совместимость ultralytics с Docker backend'ами), не покрыт планом верификации. Риск указан в `docs/plans/2026-02-15-yolo26-migration-design.md:62`, но в плане только mock-тесты.
  Особенно опасно для AMD: `ultralytics` ставится с `--no-deps` (`docker/amd/Dockerfile:23`, `docker/amd/Dockerfile:26`), и апдейт версии может сломать runtime без единого падения unit-тестов.

- Критерий финальной проверки некорректен/невыполним в текущем виде. План ожидает, что `yolo11` останется только в design-доке, но сам plan и execution prompt содержат `yolo11` по смыслу миграции.
  Это приведёт к ложным фейлам или попытке "чистить историю" документации.

### Concerns
- Утверждение "Low risk / fully backward compatible" слишком оптимистично при отсутствии ни одного реального smoke-теста загрузки `YOLO("yolo26*.pt")` и инференса.
- Диапазон `ultralytics>=8.4.0,<9.0.0` допускает непроверенные патчи; при трёх backend'ах это повышает операционный риск.
- Плановые команды не универсальны для окружений: в текущей среде `python -m pytest` из плана не работает (нет `python`, нет `pytest`).

### Suggestions
- Если "старые модели не поддерживаются" — добавить явную политику в код: allowlist/regex для `yolo26*` на входе API и в `YOLO_MODELS`.
- Расширить Definition of Done: сборка Docker, старт контейнера и `/health`, минимальный реальный инференс.
- Сделать проверку ссылок на `yolo11` точечной: `rg` с exclude/allowlist для `docs/plans/*`.
- Зафиксировать проверенную версию ultralytics.

### Questions
- "Не поддерживаются старые модели" — жёсткое требование (ошибка на `yolo11*`) или только изменение дефолтов?
- Нужна ли поддержка всех `yolo26n/s/m/l/x`, или только `s/x` как в compose-дефолтах?
- Какая минимальная обязательная матрица верификации перед merge: CPU-only или все три backend'а?
- Нужно ли сохранять исторические упоминания `yolo11` в `docs/plans/*`?

---

## gemini-executor

### Критические проблемы (Critical Issues)

1. **Отсутствие реального интеграционного тестирования (E2E)** — Мок-тесты не гарантируют, что приложение будет работать с реальной моделью `yolo26s.pt`. Если `ultralytics 8.4.0` имеет несовместимость с PyTorch/CUDA в Docker-образе, узнаете только после деплоя. Рекомендуется добавить "Smoke Test".

2. **Невоспроизводимость сборки Docker (Dependency Hell)** — В Dockerfile PyTorch устанавливается без фиксации версии, а `ultralytics` ограничен диапазоном `>=8.4.0,<9.0.0`. При сборке может быть установлена несовместимая комбинация. Рекомендуется зафиксировать версии `torch` и `torchvision`.

### Опасения (Concerns)

1. Повторная загрузка модели при каждом рестарте — отсутствует volume-mount для весов.
2. Совместимость с пользовательскими моделями на базе YOLO11.
3. Потребление ресурсов (VRAM/RAM) — нет сравнения между `yolo11s` и `yolo26s`.

### Предложения (Suggestions)

1. Добавить Volume для кэширования моделей в `docker-compose.yml`.
2. Проверить `.gitignore` на наличие `*.pt`.
3. Валидировать формат "NMS-free" выходных данных на реальном примере.

### Вопросы (Questions)

1. Есть ли механизм предварительной загрузки весов `yolo26s.pt` в Docker-образ при сборке?
2. Проверялась ли совместимость базового образа `nvidia/cuda:13.0.2` с `ultralytics 8.4.0`?

---

## ccs-executor (glmt)

### Критические проблемы

1. **Отсутствие проверки совместимости с реальным поведением YOLO26** — Mock-тесты не зависят от реального поведения. YOLO26 использует NMS-free end-to-end inference, что может изменить формат данных, порядок детекций, поведение при `max_det`.

2. **Риск breaking changes в результатах детекции** — Без NMS может вернуться больше детекций, сортировка по confidence может отличаться, прогнозы могут быть менее точными.

3. **Неполный план отката (rollback)** — Нет описания как откатиться если что-то пойдёт не так в production.

### Заботы (Concerns)

1. Версионность PyTorch в Docker — не указана версия, ultralytics 8.4.x может требовать специфическую.
2. Отсутствие валидации моделей — нет проверки, что `yolo26s.pt` существует и может быть загружен.
3. Изменение производительности — "43% faster" это marketing, не benchmarks.
4. Class names — YOLO26 может иметь другой набор class names или индексы.

### Предложения (Suggestions)

1. Фазовая миграция (optional → A/B → default → remove old).
2. Добавить comprehensive тесты с реальной ultralytics.
3. Улучшить документацию (known differences, rollback, known issues).
4. Добавить мониторинг метрик.

### Вопросы (Questions)

1. Было ли реальное тестирование с ultralytics 8.4.x и YOLO26?
2. Как NMS-free inference повлияет на результаты?
3. Какой план rollback?
4. Совместимость PyTorch в Docker?
5. Автоматическая загрузка весов? Fallback?
6. COCO class names/IDs идентичны?
7. Есть ли benchmarks для API server use case?
